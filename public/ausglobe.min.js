/*!
 * Copyright(c) 2012-2013 National ICT Australia Limited (NICTA).  All rights reserved.
 */

/*! ausglobe 2014-05-20 */
!function(a){if("object"==typeof exports)module.exports=a();else if("function"==typeof define&&define.amd)define(a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.ausglobe=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){"use strict";function c(a,b){return Math.abs((a-b)/b)<1e-5}var d=a("./Variable"),e=Cesium.defaultValue,f={},g={LON:0,LAT:1,ALT:2,TIME:3,SCALAR:4,ENUM:5},h=function(){this._nodataVal=1e-34,this._rowCnt=0,this._dataShape=void 0,this._varID=[],this._variables=void 0,this._loadingData=!1};h.prototype.getExtent=function(){var a=[0,0,0],b=[0,0,0],c=[g.LON,g.LAT,g.ALT];for(var d in c)this._varID[c[d]]&&(a[d]=this._variables[this._varID[c[d]]].min,b[d]=this._variables[this._varID[c[d]]].max);return Cesium.Rectangle.fromDegrees(a[0],a[1],b[0],b[1])},h.prototype.getMinVal=function(){return this._variables&&this._varID[g.SCALAR]?this._variables[this._varID[g.SCALAR]].min:void 0},h.prototype.getMaxVal=function(){return this._variables&&this._varID[g.SCALAR]?this._variables[this._varID[g.SCALAR]].max:void 0},h.prototype.getMinTime=function(){return this._variables&&this._varID[g.TIME]?this._variables[this._varID[g.TIME]].time_var.min:void 0},h.prototype.getMaxTime=function(){return this._variables&&this._varID[g.TIME]?this._variables[this._varID[g.TIME]].time_var.max:void 0},h.prototype.getVarList=function(){var a=[];for(var b in this._variables)(this._variables[b].type===g.SCALAR||this._variables[b].type===g.ENUM)&&a.push(b);return a},h.prototype._processVariables=function(){this._varID=[];for(var a in this._variables){var b=this._variables[a];void 0===b.type&&b.guessVarType(a),b.type===g.TIME&&(b.processTimeVar(),void 0===b.time_var&&(b.type=g.SCALAR)),b.type!==g.TIME&&b._calculateVarMinMax(),b.type===g.SCALAR&&b.min>b.max&&(b.type=g.ENUM,b.processEnumVar());for(var c in g)void 0===this._varID[g[c]]&&b.type===g[c]&&(this._varID[g[c]]=a)}this._var_name&&this._var_name.length&&this._variables[this._var_name]&&(this._varID[g.SCALAR]=this._var_name),void 0===this._varID[g.SCALAR]&&(this._varID[g.SCALAR]=this._varID[g.ENUM]),this._rowCnt=this._variables[this._varID[g.SCALAR]].vals.length,void 0===this._dataShape&&(this._dataShape=[this._rowCnt])},h.prototype.loadJson=function(a){this._dataShape=void 0,this._variables={};for(var b=a[0],c=0;c<b.length;c++){for(var e=b[c],f=new d,g=1;g<a.length;++g)f.vals.push(a[g][c]);this._variables[e]=f}this._processVariables(),this._var_name&&this.setCurrentVariable({variable:this._var_name}),console.log(this),this._loadingData=!1},h.prototype.loadText=function(a){var b=$.csv.toArrays(a,{onParseValue:$.csv.hooks.castToScalar});this.loadJson(b)},h.prototype.loadUrl=function(a){if(a=e(a,f),this._url=e(a.url,this._url),this._var_name=e(a.variable,""),this._url){console.log("loading: "+this._url),this._loadingData=!0;var b=this;Cesium.when(Cesium.loadText(this._url),function(a){b.loadText(a)})}},h.prototype.setCurrentVariable=function(a){this._variables[a.variable]&&0!==this._variables[a.variable].vals.length&&(this._var_name=a.variable,this._var_name.length&&this._variables[this._var_name]&&(this._varID[g.SCALAR]=this._var_name))},h.prototype.getCurrentVariable=function(){return this._varID[g.SCALAR]},h.prototype.getDataValue=function(a,b){var c=this._variables[a];return void 0===c||void 0===c.vals?void 0:c.type===g.ENUM?c.enum_list[c.vals[b]]:c.type===g.TIME?c.time_var.vals[b]:c.vals[b]},h.prototype.getDataValues=function(a){return void 0===this._variables[a]||void 0===this._variables[a].vals?void 0:this._variables[a].vals},h.prototype.isNoData=function(a){return c(this._nodataVal,a)},h.prototype.getPointList=function(a){var b=this._varID[g.LON]?this._variables[this._varID[g.LON]].vals:void 0,c=this._varID[g.LAT]?this._variables[this._varID[g.LAT]].vals:void 0,d=this._varID[g.ALT]?this._variables[this._varID[g.ALT]].vals:void 0,e=this._variables[this._varID[g.SCALAR]].vals,f=this._varID[g.TIME]?this._variables[this._varID[g.TIME]].time_var.vals:void 0;void 0===a&&(a=e.length);for(var h=[],i=0;i<e.length&&a>i;i++){var j={val:e[i]};j.time=f?f[i]:void 0,j.pos=[b?b[i]:0,c?c[i]:0,d?d[i]:0],h.push(j)}return h},h.prototype.destroy=function(){return Cesium.destroyObject(this)},b.exports=h},{"./Variable":5}],2:[function(a,b){"use strict";var c=Cesium.defaultValue,d=function(a){this.name=c(a.name,"New Item"),this.show=c(a.show,!0),this.type=c(a.type,"UNKNOWN"),this.primitive=c(a.primitive,void 0),this.extent=c(a.extent,void 0),this.url=c(a.url,void 0),this.style=c(a.style,void 0)};b.exports=d},{}],3:[function(a,b){"use strict";function c(a,b){var c=a.length,d=b.length;return c>d&&-1!==a.indexOf(b,c-d)}function d(a){if(void 0===a.geometryType||void 0===a.features||"FeatureCollection"===a.type)return a;a.type="FeatureCollection",a.crs={type:"EPSG",properties:{code:"4326"}};for(var b=0;b<a.features.length;b++){var c=a.features[b];if(c.type="Feature",c.properties=c.attributes,"esriGeometryPoint"===a.geometryType){var d=[c.geometry.x,c.geometry.y],e={type:"Point",coordinates:d};c.geometry=e}else if("esriGeometryPolyline"===a.geometryType){var d=c.geometry.paths[0],e={type:"LineString",coordinates:d};c.geometry=e}else if("esriGeometryPolygon"===a.geometryType){var d=c.geometry.paths[0],e={type:"Polygon",coordinates:d};c.geometry=e}}return a}function e(a){for(var b=a.split(/[ ,]+/),c=[],d=0;d<b.length;d+=2)c.push([parseFloat(b[d+1]),parseFloat(b[d])]);return c}function f(a,b){var c={type:"Feature"},d="Point"===b?e(a.pos)[0]:e(a.posList);return c.geometry={type:b,coordinates:d},c}function g(a){for(var b={type:"FeatureCollection",crs:{type:"EPSG",properties:{code:"4326"}},features:[]},c=0;c<a.featureMember.length;c++)q(a.featureMember[c],"Point",function(a){b.features.push(f(a,"Point"))}),q(a.featureMember[c],"LineString",function(a){b.features.push(f(a,"LineString"))}),q(a.featureMember[c],"Polygon",function(a){b.features.push(f(a,"Polygon"))});return b}function h(a,b){for(var c=0;c<a.length;c++)a[c].Layer?(1===a[c].queryable&&b.push(a[c]),h(a[c].Layer,b)):b.push(a[c])}function i(a){return function(b){return m(b,a)}}function j(a){Cesium.loadText("http://spatialreference.org/ref/epsg/"+a.substring(5)+"/proj4/").then(function(b){console.log("Adding new string for ",a,": ",b," before loading datasource")})}function k(a){if(void 0===a.crs||"EPSG"!==a.crs.type)return"";var b=a.crs.properties.code;return a.crs.type+":"+b}function l(a){return void 0!==Cesium.GeoJsonDataSource.crsNames[a]}function m(a,b){var c=new proj4.Proj(proj4_epsg[b]),d=new proj4.Proj("EPSG:4326"),e=new proj4.Point(a[0],a[1]);proj4(c,d,e);var f=Cesium.Cartographic.fromDegrees(e.x,e.y);return Cesium.Ellipsoid.WGS84.cartographicToCartesian(f)}function n(a,b){var c=Math.min(a.west,b.west),d=Math.min(a.south,b.south),e=Math.max(a.east,b.east),f=Math.max(a.north,b.north);return new Cesium.Rectangle(c,d,e,f)}function o(a){for(var b,c,d=a.dynamicObjects,e=d.getObjects(),f=new Cesium.JulianDate,g=0;g<e.length;g++){if(e[g].vertexPositions)var h=e[g].vertexPositions.getValue(f);else{if(!e[g].position)continue;var h=[e[g].position.getValue(f)]}var c=Cesium.Ellipsoid.WGS84.cartesianArrayToCartographicArray(h),i=Cesium.Rectangle.fromCartographicArray(c);b=void 0===b?i:n(b,i)}return b}function p(a,b,c){if(!(a[0]instanceof Array))return a;if(a.length<100)return a;for(var d,e=[],f=0;f<a.length;f+=d)for(e.push(a[f]),d=1;c>d&&!(f+d>=a.length)&&!(Math.abs(a[f][0]-a[f+d][0])+Math.abs(a[f][1]-a[f+d][1])>b);d++);return console.log(a.length,"points reduced to",e.length),e}function q(a,b,c){for(var d in a)a.hasOwnProperty(d)!==!1&&(void 0!==a[b]?c&&"function"==typeof c&&c(a[b]):"object"==typeof a[d]&&q(a[d],b,c))}function r(a){q(a,"coordinates",function(a){a=y(a,function(a){return p(a,.01,20)})})}function s(a){var b=a[C++%a.length];return new Cesium.Color(b[0]/255,b[1]/255,b[2]/255,b[3]/255)}function t(a){return a instanceof Cesium.Color?a:new Cesium.Color(a.red,a.green,a.blue,a.alpha)}var u=a("./TableDataSource"),v=a("./GeoData"),w=(Cesium.defaultValue,function(){this.layers=[],this.shareRequest=!1,this.visStore="http://geospace.research.nicta.com.au:3000";var a=this;this.dataSourceCollection=new Cesium.DataSourceCollection,this.GeoDataAdded=new Cesium.Event,this.GeoDataRemoved=new Cesium.Event,this.ViewerChanged=new Cesium.Event,this.ShareRequest=new Cesium.Event,Cesium.loadJson("./data_sources.json").then(function(b){a.serviceList=b})});w.prototype.setViewer=function(a){{var b=a.scene;a.map}b?(this.dataSourceDisplay=new Cesium.DataSourceDisplay(b,this.dataSourceCollection),this.imageryLayersCollection=b.globe.imageryLayers):void 0!==this.dataSourceDisplay&&this.dataSourceDisplay.destroy(),this.ViewerChanged.raiseEvent(this,a);for(var c=0;c<this.layers.length;c++)console.log("Redisplay Layer",this.layers[c].name),this.layers[c].map=a.map,this.layers[c].skip=!0,this.sendLayerRequest(this.layers[c])},w.prototype.setShareRequest=function(a){this.shareRequest=!1;var b=this.getShareRequest(a);this.ShareRequest.raiseEvent(this,b)},w.prototype._getUniqueLayerName=function(a){for(var b=a,c=!0,d=1;c;){c=!1;for(var e=0;e<this.layers.length;e++)this.layers[e].name===a&&(c=!0);c&&(a=b+" ("+d+")",d++)}return a},w.prototype.update=function(a){void 0===this.dataSourceDisplay||this.dataSourceDisplay.isDestroyed()||this.dataSourceDisplay.update(a)},w.prototype.add=function(a){return a.skip?(a.skip=!1,a):(a.name=this._getUniqueLayerName(a.name),this.layers.push(a),this.GeoDataAdded.raiseEvent(this,a),a)},w.prototype.get=function(a){return this.layers[a]},w.prototype.remove=function(a){var b=this.get(a);b.dataSource?this.dataSourceCollection.contains(b.dataSource)?this.dataSourceCollection.remove(b.dataSource):b.dataSource.destroy():this.imageryLayersCollection.remove(b.primitive),this.layers.splice(a,1),this.GeoDataRemoved.raiseEvent(this,b)},w.prototype.show=function(a,b){a.show=b,a.dataSource?b?this.dataSourceCollection.add(a.dataSource):this.dataSourceCollection.remove(a.dataSource,!1):a.primitive.show=b},w.prototype._stringify=function(){for(var a=[],b=0;b<this.layers.length;b++){var c={};for(var d in this.layers[b])this.layers[b].hasOwnProperty(d)&&"primitive"!==d&&"dataSource"!==d&&(c[d]=this.layers[b][d]);a.push(c)}return JSON.stringify(a)},w.prototype._parse=function(a){for(var b=JSON.parse(a),c=[],d=0;d<b.length;d++){var e=b[d];for(var f in e)if(e[f].west){var g=e[f];e[f]=new Cesium.Rectangle(g.west,g.south,g.east,g.north)}c.push(e)}return c},w.prototype.loadUrl=function(a){var b=new URI(a),c={vis_server:this.visStore,vis_id:void 0,data_url:void 0},d=b.search(!0);$.extend(c,d),this.visStore=c.vis_server,this.visID=c.vis_id,this.dataUrl=c.data_url;var e=this;if(this.visID){var a=this.visStore+"/get_rec?vis_id="+this.visID;Cesium.when(Cesium.loadJson(a),function(a){console.log(a),e.visID=a._id;for(var b=(JSON.parse(a.camera),e._parse(a.layers)),c=0;c<b.length;c++)e.sendLayerRequest(b[c])})}else this.dataUrl&&Cesium.loadText(this.dataUrl).then(function(a){e.loadText(a,e.dataUrl)})},w.prototype.getShareRequest=function(a){var b={};b.title="",b.description="";for(var c=[],d=0;d<this.layers.length;d++)c.push(this.layers[d].name);b.tags=c.toString(),b.layers=this._stringify(),b.version="0.0.01",b.image=a.image;var e=a.camera;return void 0!==e&&(b.camera=JSON.stringify({e:e.positionWC,v:e.directionWC,u:e.upWC})),this.visID&&(b.parent=this.visID),b},w.prototype.formatSupported=function(a){for(var b=[".CZML",".GEOJSON",".JSON",".TOPOJSON",".KML",".GPX",".CSV"],d=a.toUpperCase(),e=0;e<b.length;e++)if(c(d,b[e]))return!0;return!1},w.prototype.loadText=function(a,b){var d=b.toUpperCase();if(console.log(d),c(d,".CZML")){var e=new Cesium.CzmlDataSource;e.load(JSON.parse(a)),this.dataSourceCollection.add(e),h=new v({name:b,type:"DATA"}),h.dataSource=e,h.extent=o(e),this.add(h)}else if(c(d,".GEOJSON")||c(d,".JSON")||c(d,".TOPOJSON"))h=new v({name:b,type:"DATA"}),this.addGeoJsonLayer(JSON.parse(a),b,h),this.add(h);else if(c(d,".KML")){h=new v({name:b,type:"DATA"});var f=(new DOMParser).parseFromString(a,"text/xml");this.addGeoJsonLayer(toGeoJSON.kml(f),b,h),this.add(h)}else if(c(d,".GPX")){h=new v({name:b,type:"DATA"});var f=(new DOMParser).parseFromString(a,"text/xml");this.addGeoJsonLayer(toGeoJSON.gpx(f),b,h),this.add(h)}else{if(!c(d,".CSV"))return console.log("There is no handler for this file based on its extension : "+b),!1;var g=new u;g.loadText(a),this.dataSourceCollection.add(g);var h=new v({name:b,type:"DATA"});h.dataSource=g,h.extent=g.dataset.getExtent(),this.add(h)}return!0},w.prototype._viewFeature=function(a,b){var c=this;console.log("GeoJSON request",a),console.log(a),Cesium.when(Cesium.loadText(a),function(a){var e;"{"===a[0]?(e=JSON.parse(a),e=d(e)):(e=$.xml2json(a),e=g(e)),b=c.addGeoJsonLayer(e,b.name+".geojson",b),c.add(b)})},w.prototype._viewMap=function(a,b){if(void 0===b.map){var c,d=new URI(a),e=a.substring(0,a.indexOf("?")),f=d.search(!0),g=f.layers,h="http://"+d.hostname()+d.path();f.proxy&&(c=new Cesium.DefaultProxy("/proxy/"));var i=new Cesium.WebMapServiceImageryProvider({url:h,layers:encodeURIComponent(g),parameters:{format:"image/png",transparent:"true",styles:""},proxy:c});b.primitive=this.imageryLayersCollection.addImageryProvider(i)}else{var d=new URI(a),e=a.substring(0,a.indexOf("?")),f=d.search(!0),g=f.layers;L.tileLayer.wms(e,{layers:g,format:"image/png",transparent:!0}).addTo(b.map),console.log(g,b.map)}this.add(b)},w.prototype._viewTable=function(a,b){var c=this;Cesium.when(Cesium.loadText(a),function(a){var d=new u;if(d.loadText(a),void 0===b.map)c.dataSourceCollection.add(d),b.dataSource=d;else{for(var e=d.dataset.getPointList(),f=[],g=0;g<e.length;g++)f.push({type:"Point",coordinates:e[g].pos});L.geoJson(f).addTo(b.map)}c.add(b)})},w.prototype.sendLayerRequest=function(a){var b=a.url;if(console.log("LAYER REQUEST:",b),"WFS"===a.type||"REST"===a.type||"CKAN"===a.type||"GME"===a.type){if(a.proxy){var c=new Cesium.DefaultProxy("/proxy/");b=c.getURL(b)}this._viewFeature(b,a)}else if("WMS"===a.type)a.proxy&&(b+="&proxy=true"),this._viewMap(b,a);else{if("CSV"!==a.type)throw new DeveloperError("Creating layer for unsupported service: "+a.type);this._viewTable(b,a)}},w.prototype.getOGCFeatureURL=function(a){console.log("Getting ",a.feature);var b=a.base_url,c=encodeURIComponent(a.Name);if("WMS"===a.type)return b+="?service=wms&request=GetMap&layers="+c;if("WFS"===a.type)b+="?service=wfs&request=GetFeature&typeName="+c+"&version="+a.version+"&srsName=EPSG:4326",void 0===a.esri&&(b+="&outputFormat=JSON"),a.count&&(b+=a.version<2?"&maxFeatures="+a.count:"&count="+a.count);else{if("REST"!==a.type)throw new Cesium.DeveloperError("Getting feature for unsupported service: "+a.type);b+="/"+a.idx,b+="/query?geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&returnGeometry=true&f=pjson"}if(a.extent){var d=a.extent,e=[Cesium.Math.toDegrees(d.west),Cesium.Math.toDegrees(d.south),Cesium.Math.toDegrees(d.east),Cesium.Math.toDegrees(d.north)],f=parseFloat(a.version);b="WFS"===a.type&&1.1>=f?b+"&bbox="+e[0]+","+e[1]+","+e[2]+","+e[3]:"REST"===a.type?b+"&geometry="+e[0]+","+e[1]+","+e[2]+","+e[3]:b+"&bbox="+e[1]+","+e[0]+","+e[3]+","+e[2]+",urn:x-ogc:def:crs:EPSG:6.9:4326"}return b},w.prototype.handleCapabilitiesRequest=function(a,b){var c;c="{"===a[0]?JSON.parse(a):$.xml2json(a),console.log(c);var d=[];if("WFS"===b.type)d=c.FeatureTypeList.FeatureType,c.Esri&&(b.esri=!0);else if("WMS"===b.type){var e=[c.Capability.Layer];h(e,d)}else if("REST"===b.type){d=c.layers;for(var f=0;f<d.length;f++)d[f].Name=d[f].name;var g=c.fullExtent;b.extent=Cesium.Rectangle.fromDegrees(parseFloat(g.xmin),parseFloat(g.ymin),parseFloat(g.xmax),parseFloat(g.ymax))}else if("CSV"===b.type)d=c.Layer;else if("GME"===b.type)d=c.Layer;else{if("CKAN"!==b.type)throw new DeveloperError("Getting capabilities for unsupported service: "+b.type);d=c.result.results;for(var f=0;f<d.length;f++)d[f].Name=d[f].name;b.extent}c.ServiceIdentification?b.version=parseFloat(c.ServiceIdentification.ServiceTypeVersion):c.Service&&(b.version=parseFloat(c.version)),b.Layer=d},w.prototype.getCapabilities=function(a,b){var c;if(c="CSV"===a.type||"GME"===a.type?a.base_url:"REST"===a.type?a.base_url+"?f=pjson":"CKAN"===a.type?a.base_url+"/api/3/action/package_search?q=GeoJSON&rows=50":a.base_url+"?service="+a.type+"&request=GetCapabilities",a.proxy){var d=new Cesium.DefaultProxy("/proxy/");c=d.getURL(c)}console.log("CAPABILITIES REQUEST:",c);var e=this;Cesium.when(Cesium.loadText(c),function(c){e.handleCapabilitiesRequest(c,a),b(a)})};for(var x in proj4_epsg)Cesium.GeoJsonDataSource.crsNames[x]=i(x);var y=function(a,b){if(!(a[0]instanceof Array&&a[0][0]instanceof Array))return a=b(a);for(var c=0;c<a.length;c++)a[c]=y(a[c],b);return a},z=function(a,b){if(a[0]instanceof Array)if(a[0][0]instanceof Array)for(var c=0;c<a.length;c++)z(a[c],b);else b.tot+=a.length,a.length>b.longest&&(b.longest=a.length);else b.tot++},A=[[204,197,24,255],[104,197,124,255],[104,107,224,255],[230,87,74,255],[104,197,24,255],[104,227,124,255],[104,227,124,255]],B=[[200,200,0,255],[200,0,0,255],[0,200,200,255],[0,200,0,255],[0,0,200,255],[200,0,200,255],[200,200,200,255]],C=0;w.prototype.addGeoJsonLayer=function(a,b,c){void 0===c.style&&(c.style={line:{},point:{},polygon:{}},c.style.line.color=s(A),c.style.line.width=2,c.style.point.color=s(B),c.style.point.size=10,c.style.polygon.color=c.style.line.color,c.style.polygon.fill=!1,c.style.polygon.fillcolor=c.style.line.color,c.style.polygon.fillcolor.alpha=.5);var d=new Cesium.GeoJsonDataSource,e=d.defaultPoint,f=new Cesium.DynamicPoint;f.color=new Cesium.ConstantProperty(t(c.style.point.color)),f.pixelSize=new Cesium.ConstantProperty(c.style.point.size),f.outlineColor=new Cesium.ConstantProperty(Cesium.Color.BLACK),f.outlineWidth=new Cesium.ConstantProperty(1),e.point=f;var g=d.defaultLine,h=new Cesium.DynamicPolyline,i=new Cesium.ColorMaterialProperty;i.color=new Cesium.ConstantProperty(t(c.style.line.color)),h.material=i,h.width=new Cesium.ConstantProperty(c.style.line.width),g.polyline=h;var m=d.defaultPolygon;m.polyline=h;var n=new Cesium.DynamicPolygon;n.fill=new Cesium.ConstantProperty(c.style.polygon.fill),m.polygon=n,i=new Cesium.ColorMaterialProperty,i.color=new Cesium.ConstantProperty(t(c.style.polygon.fillcolor)),n.material=i;var p=k(a);if(""!==p&&"EPSG:4326"!==p)l(p)?console.log("GeoJSONDataSource will convert this"):(console.log("===Going to spatial reference service to try to get proj4 string"),j(p,function(){console.log("ADD LOADING FUNC HERE")}));else{var u=JSON.stringify(a).length,v={tot:0,longest:0};q(a,"coordinates",function(a){z(a,v)}),console.log("finished",v),v.longest>100&&v.tot>1e5&&(r(a),console.log("downsampled object from",u,"bytes to",JSON.stringify(a).length))}if(void 0===c.map)d.load(a),this.dataSourceCollection.add(d),c.dataSource=d,c.extent||(c.extent=o(d));else{var w={color:"#ff7800",weight:5,opacity:.65};L.geoJson(a,{style:w}).addTo(c.map)}return c},b.exports=w},{"./GeoData":2,"./TableDataSource":4}],4:[function(a,b){"use strict";var c=a("./Dataset"),d=(Cesium.defaultValue,function(){this.czmlDataSource=new Cesium.CzmlDataSource,this.dataset=new c,this.show=!0,this.color=Cesium.Color.RED,this.pts_max=1e4,this.leadTimeMin=0,this.trailTimeMin=60,this.scale=1,this.scale_by_val=!0;var a=[{offset:0,color:"#00f"},{offset:.25,color:"#0ff"},{offset:.25,color:"#0ff"},{offset:.5,color:"#0f0"},{offset:.5,color:"#0f0"},{offset:.75,color:"#ff0"},{offset:.75,color:"#ff0"},{offset:1,color:"#f00"}];this.colorGradient=a,this.setColorGradient(a)});Cesium.defineProperties(d.prototype,{name:{get:function(){return this.czmlDataSource.name}},clock:{get:function(){return this.czmlDataSource.clock}},dynamicObjects:{get:function(){return this.czmlDataSource.dynamicObjects}},isLoading:{get:function(){return this.czmlDataSource.isLoading}},changedEvent:{get:function(){return this.czmlDataSource.changedEvent}},errorEvent:{get:function(){return this.czmlDataSource.errorEvent}},loadingEvent:{get:function(){return this.czmlDataSource.loadingEvent}}}),d.prototype.loadUrl=function(a){var b=this;this.dataset.loadUrl({url:a,callback:function(){b.setLeadTimeByPercent(0),b.setTrailTimeByPercent(1),b.czmlDataSource.load(b.getDataPointList(),"TableDataSource")}})},d.prototype.loadText=function(a){var b=this;this.dataset.loadText(a),b.setLeadTimeByPercent(0),b.setTrailTimeByPercent(1),b.czmlDataSource.load(b.getDataPointList(),"TableDataSource")},d.prototype.setCurrentVariable=function(a){var b=this;this.dataset.setCurrentVariable({variable:a,callback:function(){b.czmlDataSource.load(b.getDataPointList(),"TableDataSource")}})},d.prototype.czmlRecFromPoint=function(a){var b={billboard:{horizontalOrigin:"CENTER",verticalOrigin:"BOTTOM",image:"./images/pow32.png",scale:1,color:{rgba:[255,0,0,255]},show:[{interval:"2011-02-04T16:00:00Z/2011-04-04T18:00:00Z","boolean":!0}]},position:{cartographicDegrees:[0,0,0]}};b.billboard.color.rgba=this._mapValue2Color(a.val),b.billboard.scale=this._mapValue2Scale(a.val);for(var c=0;3>c;c++)b.position.cartographicDegrees[c]=a.pos[c];var d=a.time.addMinutes(-this.leadTimeMin),e=a.time.addMinutes(this.trailTimeMin);return b.billboard.show[0].interval=d.toIso8601()+"/"+e.toIso8601(),b},d.prototype.getDataPointList=function(){var a=this.dataset;if(!a._loadingData){for(var b=this.dataset.getPointList(),c=[],d=0;d<b.length;d++){var e=this.czmlRecFromPoint(b[d]);c.push(e)}return c}},d.prototype._getNormalizedPoint=function(a){var b=this.dataset;if(void 0===b||b.isNoData(a))return void 0;var c=b.getMinVal(),d=b.getMaxVal(),e=d===c?0:(a-c)/(d-c);return e},d.prototype._mapValue2Scale=function(a){var b=this.scale,c=this._getNormalizedPoint(a);return void 0!==c&&(b*=this.scale_by_val?1*c+.5:1),b},d.prototype._mapValue2Color=function(a){var b=this.dataImage;if(void 0===b)return this.color;var c=this._getNormalizedPoint(a),d=[0,0,0,0];if(void 0!==c){var e=4*Math.floor(c*(b.data.length/4-1));d=b.data.subarray(e,e+4),d[3]*=this.color.alpha}return d},d.prototype.setLeadTimeByPercent=function(a){if(this.dataset){var b=this.dataset;this.leadTimeMin=b.getMinTime().getMinutesDifference(b.getMaxTime())*a/100}},d.prototype.setTrailTimeByPercent=function(a){if(this.dataset){var b=this.dataset;this.trailTimeMin=b.getMinTime().getMinutesDifference(b.getMaxTime())*a/100}},d.prototype.createGradient=function(a){for(var b=a.canvas.width,c=a.canvas.height,d=a.createLinearGradient(0,0,0,c),e=this.colorGradient,f=0;f<e.length;f++)d.addColorStop(e[f].offset,e[f].color);a.fillStyle=d,a.fillRect(0,0,b,c)},d.prototype.setColorGradient=function(){document.getElementById("grad_div")||($("body").append('<div id="grad_div"></div>'),$("<canvas/>",{id:"gradCanvas",Width:64,Height:256,Style:"display: none"}).appendTo("#grad_div"));var a=$("#gradCanvas")[0],b=a.getContext("2d");this.createGradient(b),this.dataImage=b.getImageData(0,0,1,256)},d.prototype.destroy=function(){return Cesium.destroyObject(this)},b.exports=d},{"./Dataset":1}],5:[function(a,b){"use strict";function c(a){return!isNaN(parseFloat(a))&&isFinite(a)}function d(a){var b=a.split(/[/-]/);return 3===b.length&&(a=b[1]+"/"+b[0]+"/"+b[2]),a}var e={LON:0,LAT:1,ALT:2,TIME:3,SCALAR:4,ENUM:5},f=function(){this.vals=[],this.fNoData=1e-34,this.min=void 0,this.max=void 0,this.type=void 0,this.time_var=void 0,this.enum_list=void 0};f.prototype._calculateVarMinMax=function(){for(var a=this.vals,b=Number.MAX_VALUE,c=-Number.MAX_VALUE,d=0;d<a.length;d++)void 0===a[d]||null===a[d]?a[d]=this.fNoData:(b>a[d]&&(b=a[d]),c<a[d]&&(c=a[d]));this.min=b,this.max=c},f.prototype._calculateTimeMinMax=function(){for(var a=this.vals,b=a[0],c=a[0],d=1;d<a.length;d++)b.greaterThan(a[d])&&(b=a[d]),c.lessThan(a[d])&&(c=a[d]);this.min=b,this.max=c},f.prototype.processTimeVar=function(){function a(a){return Cesium.JulianDate.fromDate(new Date(a))}function b(a){var b=Cesium.JulianDate.fromDate(new Date("January 1, 1970 0:00:00"));return b=b.addDays(Math.floor(a)-25569),b=b.addSeconds(60*(a-Math.floor(a))*60*24)}function g(a){return Cesium.JulianDate.fromDate(Date.setTime(a))}function h(a){var b=new Cesium.JulianDate(0,0),c=a.toString(),d=parseInt(c.substring(0,4),10),e=parseInt(c.substring(4,7),10);if(14!==c.length||1950>d||d>2050||e>366)return b;var f=new Date;return f.setUTCFullYear(d),f.setUTCHours(c.substring(7,9),c.substring(9,11),c.substring(11,13)),b=Cesium.JulianDate.fromDate(f).addDays(e)}if(this.type===e.TIME){var i,j=new f,k=this.vals;i=parseInt(k[0],10)>5e5?0!==h(k[0]).getJulianDayNumber()?h:g:c(k[0])?b:a;var l=!1;try{for(var m=0;m<k.length;m++)j.vals[m]=i(k[m]);l=!0}catch(n){if(i===a){console.log("Trying swap of day and month in date strings"),j.vals=[];try{for(var m=0;m<k.length;m++)j.vals[m]=i(d(k[m]));l=!0}catch(n){}}}l?(j._calculateTimeMinMax(),this.time_var=j):(this.type=e.SCALAR,console.log("Unable to parse time variable"))}},f.prototype.processEnumVar=function(){if(this.type===e.ENUM){for(var a=[],b=0;b<this.vals.length;b++){this.vals[b]===this.fNoData&&(this.vals[b]="undefined");var c=a.indexOf(this.vals[b]);-1===c&&(c=a.length,a.push(this.vals[b])),this.vals[b]=parseFloat(c)}this.enum_list=a,this.calculateVarMinMax()}},f.prototype.guessVarType=function(a){function b(a,b){var a=a.toLowerCase();for(var c in b){var d=b[c].toLowerCase();if(0===a.indexOf(d)||-1!==a.indexOf(" "+d)||-1!==a.indexOf("_"+d))return!0}return!1}var c=[{hints:["lon"],type:e.LON},{hints:["lat"],type:e.LAT},{hints:["depth","height","elevation"],type:e.ALT},{hints:["time","date"],type:e.TIME}];for(var d in c)if(b(a,c[d].hints))return void(this.type=c[d].type);this.type=e.SCALAR},f.prototype.destroy=function(){return Cesium.destroyObject(this)},b.exports=f},{}],6:[function(a,b){b.exports={Variable:a("./Variable"),Dataset:a("./Dataset"),TableDataSource:a("./TableDataSource"),GeoData:a("./GeoData"),GeoDataCollection:a("./GeoDataCollection")}},{"./Dataset":1,"./GeoData":2,"./GeoDataCollection":3,"./TableDataSource":4,"./Variable":5}]},{},[6])(6)});