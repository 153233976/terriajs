/*!
 * Copyright(c) 2012-2013 National ICT Australia Limited (NICTA).  All rights reserved.
 */

!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.ausglobe=e()}}(function(){return function e(t,a,r){function i(s,n){if(!a[s]){if(!t[s]){var l="function"==typeof require&&require;if(!n&&l)return l(s,!0);if(o)return o(s,!0);throw new Error("Cannot find module '"+s+"'")}var u=a[s]={exports:{}};t[s][0].call(u.exports,function(e){var a=t[s][1][e];return i(a?a:e)},u,u.exports,e,t,a,r)}return a[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,t){"use strict";function a(e,t){return Math.abs((e-t)/t)<1e-5}var r=e("./Variable"),i=Cesium.defaultValue,o={},s={LON:0,LAT:1,ALT:2,TIME:3,SCALAR:4,ENUM:5},n=function(){this._nodataVal=1e-34,this._rowCnt=0,this._dataShape=void 0,this._varID=[],this._variables=void 0,this._loadingData=!1};n.prototype.getExtent=function(){var e=[0,0,0],t=[0,0,0],a=[s.LON,s.LAT,s.ALT];for(var r in a)this._varID[a[r]]&&(e[r]=this._variables[this._varID[a[r]]].min,t[r]=this._variables[this._varID[a[r]]].max);return Cesium.Rectangle.fromDegrees(e[0],e[1],t[0],t[1])},n.prototype.getMinVal=function(){return this._variables&&this._varID[s.SCALAR]?this._variables[this._varID[s.SCALAR]].min:void 0},n.prototype.getMaxVal=function(){return this._variables&&this._varID[s.SCALAR]?this._variables[this._varID[s.SCALAR]].max:void 0},n.prototype.getMinTime=function(){return this._variables&&this._varID[s.TIME]?this._variables[this._varID[s.TIME]].time_var.min:void 0},n.prototype.getMaxTime=function(){return this._variables&&this._varID[s.TIME]?this._variables[this._varID[s.TIME]].time_var.max:void 0},n.prototype.getVarList=function(){var e=[];for(var t in this._variables)(this._variables[t].type===s.SCALAR||this._variables[t].type===s.ENUM)&&e.push(t);return e},n.prototype._processVariables=function(){this._varID=[];for(var e in this._variables){var t=this._variables[e];void 0===t.type&&t.guessVarType(e),t.type===s.TIME&&(t.processTimeVar(),void 0===t.time_var&&(t.type=s.SCALAR)),t.type!==s.TIME&&t._calculateVarMinMax(),t.type===s.SCALAR&&t.min>t.max&&(t.type=s.ENUM,t.processEnumVar());for(var a in s)void 0===this._varID[s[a]]&&t.type===s[a]&&(this._varID[s[a]]=e)}this._var_name&&this._var_name.length&&this._variables[this._var_name]&&(this._varID[s.SCALAR]=this._var_name),void 0===this._varID[s.SCALAR]&&(this._varID[s.SCALAR]=this._varID[s.ENUM]),this._rowCnt=this._variables[this._varID[s.SCALAR]].vals.length,void 0===this._dataShape&&(this._dataShape=[this._rowCnt])},n.prototype.loadJson=function(e){this._dataShape=void 0,this._variables={};for(var t=e[0],a=0;a<t.length;a++){for(var i=t[a],o=new r,s=1;s<e.length;++s)o.vals.push(e[s][a]);this._variables[i]=o}this._processVariables(),this._var_name&&this.setCurrentVariable({variable:this._var_name}),console.log(this),this._loadingData=!1},n.prototype.loadText=function(e){var t=$.csv.toArrays(e,{onParseValue:$.csv.hooks.castToScalar});this.loadJson(t)},n.prototype.loadUrl=function(e){if(e=i(e,o),this._url=i(e.url,this._url),this._var_name=i(e.variable,""),this._url){console.log("loading: "+this._url),this._loadingData=!0;var t=this;Cesium.when(Cesium.loadText(this._url),function(e){t.loadText(e)})}},n.prototype.setCurrentVariable=function(e){this._variables[e.variable]&&0!==this._variables[e.variable].vals.length&&(this._var_name=e.variable,this._var_name.length&&this._variables[this._var_name]&&(this._varID[s.SCALAR]=this._var_name))},n.prototype.getCurrentVariable=function(){return this._varID[s.SCALAR]},n.prototype.getDataValue=function(e,t){var a=this._variables[e];return void 0===a||void 0===a.vals?void 0:a.type===s.ENUM?a.enum_list[a.vals[t]]:a.type===s.TIME?a.time_var.vals[t]:a.vals[t]},n.prototype.getDataValues=function(e){return void 0===this._variables[e]||void 0===this._variables[e].vals?void 0:this._variables[e].vals},n.prototype.isNoData=function(e){return a(this._nodataVal,e)},n.prototype.getPointList=function(e){var t=this._varID[s.LON]?this._variables[this._varID[s.LON]].vals:void 0,a=this._varID[s.LAT]?this._variables[this._varID[s.LAT]].vals:void 0,r=this._varID[s.ALT]?this._variables[this._varID[s.ALT]].vals:void 0,i=this._variables[this._varID[s.SCALAR]].vals,o=this._varID[s.TIME]?this._variables[this._varID[s.TIME]].time_var.vals:void 0;void 0===e&&(e=i.length);for(var n=[],l=0;l<i.length&&e>l;l++){var u={val:i[l]};u.time=o?o[l]:void 0,u.pos=[t?t[l]:0,a?a[l]:0,r?r[l]:0],n.push(u)}return n},n.prototype.destroy=function(){return Cesium.destroyObject(this)},t.exports=n},{"./Variable":5}],2:[function(e,t){"use strict";var a=Cesium.defaultValue,r=function(e){this.name=a(e.name,"New Item"),this.show=a(e.show,!0),this.type=a(e.type,"UNKNOWN"),this.primitive=a(e.primitive,void 0),this.extent=a(e.extent,void 0),this.url=a(e.url,void 0),this.style=a(e.style,void 0)};t.exports=r},{}],3:[function(e,t){"use strict";function a(e,t){var a=e.length,r=t.length;return a>r&&-1!==e.indexOf(t,a-r)}function r(e){if(void 0===e.geometryType||void 0===e.features||"FeatureCollection"===e.type)return e;e.type="FeatureCollection",e.crs={type:"EPSG",properties:{code:"4326"}};for(var t=0;t<e.features.length;t++){var a=e.features[t];if(a.type="Feature",a.properties=a.attributes,"esriGeometryPoint"===e.geometryType){var r=[a.geometry.x,a.geometry.y],i={type:"Point",coordinates:r};a.geometry=i}else if("esriGeometryPolyline"===e.geometryType){var r=a.geometry.paths[0],i={type:"LineString",coordinates:r};a.geometry=i}else if("esriGeometryPolygon"===e.geometryType){var r=a.geometry.paths[0],i={type:"Polygon",coordinates:r};a.geometry=i}}return e}function i(e){for(var t=e.split(/[ ,]+/),a=[],r=0;r<t.length;r+=2)a.push([parseFloat(t[r]),parseFloat(t[r+1])]);return a}function o(e,t){var a={type:"Feature"},r="Point"===t?i(e.pos)[0]:i(e.posList);return a.geometry={type:t,coordinates:r},a}function s(e){for(var t={type:"FeatureCollection",crs:{type:"EPSG",properties:{code:"4326"}},features:[]},a=0;a<e.featureMember.length;a++)y(e.featureMember[a],"Point",function(e){t.features.push(o(e,"Point"))}),y(e.featureMember[a],"LineString",function(e){t.features.push(o(e,"LineString"))}),y(e.featureMember[a],"Polygon",function(e){t.features.push(o(e,"Polygon"))});return t}function n(e,t){for(var a=0;a<e.length;a++)e[a].Layer?(1===e[a].queryable&&t.push(e[a]),n(e[a].Layer,t)):t.push(e[a])}function l(e){return function(t){return c(t,e)}}function u(e){Cesium.loadText("http://spatialreference.org/ref/epsg/"+e.substring(5)+"/proj4/").then(function(t){console.log("Adding new string for ",e,": ",t," before loading datasource")})}function p(e){if(void 0===e.crs||"EPSG"!==e.crs.type)return"";var t=e.crs.properties.code;return e.crs.type+":"+t}function h(e){return void 0!==Cesium.GeoJsonDataSource.crsNames[e]}function c(e,t){var a=new proj4.Proj(proj4_epsg[t]),r=new proj4.Proj("EPSG:4326"),i=new proj4.Point(e[0],e[1]);proj4(a,r,i);var o=Cesium.Cartographic.fromDegrees(i.x,i.y);return Cesium.Ellipsoid.WGS84.cartographicToCartesian(o)}function v(e,t){var a=Math.min(e.west,t.west),r=Math.min(e.south,t.south),i=Math.max(e.east,t.east),o=Math.max(e.north,t.north);return new Cesium.Rectangle(a,r,i,o)}function f(e){for(var t,a,r=e.dynamicObjects,i=r.getObjects(),o=new Cesium.JulianDate,s=0;s<i.length;s++){if(i[s].vertexPositions)var n=i[s].vertexPositions.getValue(o);else{if(!i[s].position)continue;var n=[i[s].position.getValue(o)]}var a=Cesium.Ellipsoid.WGS84.cartesianArrayToCartographicArray(n),l=Cesium.Rectangle.fromCartographicArray(a);t=void 0===t?l:v(t,l)}return t}function d(e,t,a){if(!(e[0]instanceof Array))return e;if(e.length<100)return e;for(var r,i=[],o=0;o<e.length;o+=r)for(i.push(e[o]),r=1;a>r&&!(o+r>=e.length)&&!(Math.abs(e[o][0]-e[o+r][0])+Math.abs(e[o][1]-e[o+r][1])>t);r++);return console.log(e.length,"points reduced to",i.length),i}function y(e,t,a){for(var r in e)e.hasOwnProperty(r)!==!1&&(void 0!==e[t]?a&&"function"==typeof a&&a(e[t]):"object"==typeof e[r]&&y(e[r],t,a))}function m(e){y(e,"coordinates",function(e){e=w(e,function(e){return d(e,.01,20)})})}function g(e){var t=e[A++%e.length];return new Cesium.Color(t[0]/255,t[1]/255,t[2]/255,t[3]/255)}function C(e){return e instanceof Cesium.Color?e:new Cesium.Color(e.red,e.green,e.blue,e.alpha)}var _=e("./TableDataSource"),S=e("./GeoData"),D=(Cesium.defaultValue,function(){this.layers=[],this.shareRequest=!1,this.visStore="http://geospace.research.nicta.com.au:3000";var e=this;this.dataSourceCollection=new Cesium.DataSourceCollection,this.GeoDataAdded=new Cesium.Event,this.GeoDataRemoved=new Cesium.Event,this.ViewerChanged=new Cesium.Event,this.ShareRequest=new Cesium.Event,Cesium.loadJson("./data_sources.json").then(function(t){e.serviceList=t})});D.prototype.setViewer=function(e){{var t=e.scene;e.map}t?(this.dataSourceDisplay=new Cesium.DataSourceDisplay(t,this.dataSourceCollection),this.imageryLayersCollection=t.globe.imageryLayers):void 0!==this.dataSourceDisplay&&this.dataSourceDisplay.destroy(),this.ViewerChanged.raiseEvent(this,e);for(var a=0;a<this.layers.length;a++)console.log("Redisplay Layer",this.layers[a].name),this.layers[a].map=e.map,this.layers[a].skip=!0,this.sendLayerRequest(this.layers[a])},D.prototype.setShareRequest=function(e){this.shareRequest=!1;var t=this.getShareRequest(e);this.ShareRequest.raiseEvent(this,t)},D.prototype._getUniqueLayerName=function(e){for(var t=e,a=!0,r=1;a;){a=!1;for(var i=0;i<this.layers.length;i++)this.layers[i].name===e&&(a=!0);a&&(e=t+" ("+r+")",r++)}return e},D.prototype.update=function(e){void 0===this.dataSourceDisplay||this.dataSourceDisplay.isDestroyed()||this.dataSourceDisplay.update(e)},D.prototype.add=function(e){return e.skip?(e.skip=!1,e):(e.name=this._getUniqueLayerName(e.name),this.layers.push(e),this.GeoDataAdded.raiseEvent(this,e),e)},D.prototype.get=function(e){return this.layers[e]},D.prototype.remove=function(e){var t=this.get(e);t.dataSource?this.dataSourceCollection.contains(t.dataSource)?this.dataSourceCollection.remove(t.dataSource):t.dataSource.destroy():this.imageryLayersCollection.remove(t.primitive),this.layers.splice(e,1),this.GeoDataRemoved.raiseEvent(this,t)},D.prototype.show=function(e,t){e.show=t,e.dataSource?t?this.dataSourceCollection.add(e.dataSource):this.dataSourceCollection.remove(e.dataSource,!1):e.primitive.show=t},D.prototype._stringify=function(){for(var e=[],t=0;t<this.layers.length;t++){var a={};for(var r in this.layers[t])this.layers[t].hasOwnProperty(r)&&"primitive"!==r&&"dataSource"!==r&&(a[r]=this.layers[t][r]);e.push(a)}return JSON.stringify(e)},D.prototype._parse=function(e){for(var t=JSON.parse(e),a=[],r=0;r<t.length;r++){var i=t[r];for(var o in i)if(i[o].west){var s=i[o];i[o]=new Cesium.Rectangle(s.west,s.south,s.east,s.north)}a.push(i)}return a},D.prototype.loadUrl=function(e){var t=new URI(e),a={vis_server:this.visStore,vis_id:void 0,data_url:void 0},r=t.search(!0);$.extend(a,r),this.visStore=a.vis_server,this.visID=a.vis_id,this.dataUrl=a.data_url;var i=this;if(this.visID){var e=this.visStore+"/get_rec?vis_id="+this.visID;Cesium.when(Cesium.loadJson(e),function(e){console.log(e),i.visID=e._id;for(var t=(JSON.parse(e.camera),i._parse(e.layers)),a=0;a<t.length;a++)i.sendLayerRequest(t[a])})}else this.dataUrl&&Cesium.loadText(this.dataUrl).then(function(e){i.loadText(e,i.dataUrl)})},D.prototype.getShareRequest=function(e){var t={};t.title="",t.description="";for(var a=[],r=0;r<this.layers.length;r++)a.push(this.layers[r].name);t.tags=a.toString(),t.layers=this._stringify(),t.version="0.0.01",t.image=e.image;var i=e.camera;return void 0!==i&&(t.camera=JSON.stringify({e:i.positionWC,v:i.directionWC,u:i.upWC})),this.visID&&(t.parent=this.visID),t},D.prototype.formatSupported=function(e){for(var t=[".CZML",".GEOJSON",".JSON",".TOPOJSON",".KML",".GPX",".CSV"],r=e.toUpperCase(),i=0;i<t.length;i++)if(a(r,t[i]))return!0;return!1},D.prototype.loadText=function(e,t){var r=t.toUpperCase();if(console.log(r),a(r,".CZML")){var i=new Cesium.CzmlDataSource;i.load(JSON.parse(e)),this.dataSourceCollection.add(i),n=new S({name:t,type:"DATA"}),n.dataSource=i,n.extent=f(i),this.add(n)}else if(a(r,".GEOJSON")||a(r,".JSON")||a(r,".TOPOJSON"))n=new S({name:t,type:"DATA"}),this.addGeoJsonLayer(JSON.parse(e),t,n),this.add(n);else if(a(r,".KML")){n=new S({name:t,type:"DATA"});var o=(new DOMParser).parseFromString(e,"text/xml");this.addGeoJsonLayer(toGeoJSON.kml(o),t,n),this.add(n)}else if(a(r,".GPX")){n=new S({name:t,type:"DATA"});var o=(new DOMParser).parseFromString(e,"text/xml");this.addGeoJsonLayer(toGeoJSON.gpx(o),t,n),this.add(n)}else{if(!a(r,".CSV"))return console.log("There is no handler for this file based on its extension : "+t),!1;var s=new _;s.loadText(e),this.dataSourceCollection.add(s);var n=new S({name:t,type:"DATA"});n.dataSource=s,n.extent=s.dataset.getExtent(),this.add(n)}return!0},D.prototype._viewFeature=function(e,t){var a=this;if(console.log("GeoJSON request",e),t.proxy){var i=new Cesium.DefaultProxy("/proxy/");e=i.getURL(e)}Cesium.when(Cesium.loadText(e),function(e){var i;"{"===e[0]?(i=JSON.parse(e),i=r(i)):(i=$.xml2json(e),i=s(i),console.log(i)),t=a.addGeoJsonLayer(i,t.name+".geojson",t),a.add(t)})},D.prototype._viewMap=function(e,t){if(void 0===t.map){var a,r,i=new URI(e),o=(e.substring(0,e.indexOf("?")),i.search(!0)),s=o.layers,n="http://"+i.hostname()+i.path();t.proxy&&(r=new Cesium.DefaultProxy("/proxy/")),a="REST"===s?new Cesium.ArcGisMapServerImageryProvider({url:n,proxy:r}):new Cesium.WebMapServiceImageryProvider({url:n,layers:encodeURIComponent(s),parameters:{format:"image/png",transparent:"true",styles:""},proxy:r}),t.primitive=this.imageryLayersCollection.addImageryProvider(a)}else{var i=new URI(e),l=e.substring(0,e.indexOf("?")),o=i.search(!0),s=o.layers;t.proxy&&(r=new Cesium.DefaultProxy("/proxy/"),l=r.getURL(l)),a="REST"===s?new L.esri.TiledMapLayer(l):new L.tileLayer.wms(e,{layers:s,format:"image/png",transparent:!0}),t.map.addLayer(a)}this.add(t)},D.prototype._viewTable=function(e,t){var a=this;Cesium.when(Cesium.loadText(e),function(e){var r=new _;if(r.loadText(e),void 0===t.map)a.dataSourceCollection.add(r),t.dataSource=r;else{for(var i=r.dataset.getPointList(),o=[],s=0;s<i.length;s++)o.push({type:"Point",coordinates:i[s].pos});L.geoJson(o).addTo(t.map)}a.add(t)})},D.prototype.sendLayerRequest=function(e){var t=e.url;if(console.log("LAYER REQUEST:",t),"WFS"===e.type||"REST"===e.type||"CKAN"===e.type||"GME"===e.type)this._viewFeature(t,e);else if("WMS"===e.type)this._viewMap(t,e);else{if("CSV"!==e.type)throw new DeveloperError("Creating layer for unsupported service: "+e.type);this._viewTable(t,e)}},D.prototype.getOGCFeatureURL=function(e){console.log("Getting ",e.feature);var t=e.base_url,a=encodeURIComponent(e.Name);if("WMS"===e.type)return t+="?service=wms&request=GetMap&layers="+a;if("WFS"===e.type)e.version="1.1.0",t+="?service=wfs&request=GetFeature&typeName="+a+"&version=1.1.0&srsName=EPSG:4326",-1!==t.indexOf("www.ga.gov.au")&&(e.esri=!0),void 0===e.esri&&(t+="&outputFormat=JSON"),e.count&&(t+="&maxFeatures="+e.count);else{if("REST"!==e.type)throw new Cesium.DeveloperError("Getting feature for unsupported service: "+e.type);t+="/"+e.idx,t+="/query?geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&returnGeometry=true&f=pjson"}if(e.extent){var r=e.extent,i=[Cesium.Math.toDegrees(r.west),Cesium.Math.toDegrees(r.south),Cesium.Math.toDegrees(r.east),Cesium.Math.toDegrees(r.north)],o=parseFloat(e.version);t="WFS"===e.type&&1.1>=o?t+"&bbox="+i[0]+","+i[1]+","+i[2]+","+i[3]:"REST"===e.type?t+"&geometry="+i[0]+","+i[1]+","+i[2]+","+i[3]:t+"&bbox="+i[1]+","+i[0]+","+i[3]+","+i[2]+",urn:x-ogc:def:crs:EPSG:6.9:4326"}return t},D.prototype.handleCapabilitiesRequest=function(e,t){var a;a="{"===e[0]?JSON.parse(e):$.xml2json(e),console.log(a);var r=[];if("WFS"===t.type)r=a.FeatureTypeList.FeatureType;else if("WMS"===t.type){var i=[a.Capability.Layer];n(i,r)}else if("REST"===t.type){r=a.layers;for(var o=0;o<r.length;o++)r[o].Name=r[o].name;var s=a.fullExtent;t.extent=Cesium.Rectangle.fromDegrees(parseFloat(s.xmin),parseFloat(s.ymin),parseFloat(s.xmax),parseFloat(s.ymax))}else if("CSV"===t.type)r=a.Layer;else if("GME"===t.type)r=a.Layer;else{if("CKAN"!==t.type)throw new DeveloperError("Getting capabilities for unsupported service: "+t.type);r=a.result.results;for(var o=0;o<r.length;o++)r[o].Name=r[o].name;t.extent}a.ServiceIdentification?t.version=parseFloat(a.ServiceIdentification.ServiceTypeVersion):a.Service&&(t.version=parseFloat(a.version)),t.Layer=r},D.prototype.getCapabilities=function(e,t){var a;if(a="CSV"===e.type||"GME"===e.type?e.base_url:"REST"===e.type?e.base_url+"?f=pjson":"CKAN"===e.type?e.base_url+"/api/3/action/package_search?q=GeoJSON&rows=50":e.base_url+"?service="+e.type+"&request=GetCapabilities",e.proxy){var r=new Cesium.DefaultProxy("/proxy/");a=r.getURL(a)}console.log("CAPABILITIES REQUEST:",a);var i=this;Cesium.when(Cesium.loadText(a),function(a){i.handleCapabilitiesRequest(a,e),t(e)})};for(var b in proj4_epsg)Cesium.GeoJsonDataSource.crsNames[b]=l(b);var w=function(e,t){if(!(e[0]instanceof Array&&e[0][0]instanceof Array))return e=t(e);for(var a=0;a<e.length;a++)e[a]=w(e[a],t);return e},T=function(e,t){if(e[0]instanceof Array)if(e[0][0]instanceof Array)for(var a=0;a<e.length;a++)T(e[a],t);else t.tot+=e.length,e.length>t.longest&&(t.longest=e.length);else t.tot++},x=[[204,197,24,255],[104,197,124,255],[104,107,224,255],[230,87,74,255],[104,197,24,255],[104,227,124,255],[104,227,124,255]],M=[[200,200,0,255],[200,0,0,255],[0,200,200,255],[0,200,0,255],[0,0,200,255],[200,0,200,255],[200,200,200,255]],A=0;D.prototype.addGeoJsonLayer=function(e,t,a){void 0===a.style&&(a.style={line:{},point:{},polygon:{}},a.style.line.color=g(x),a.style.line.width=2,a.style.point.color=g(M),a.style.point.size=10,a.style.polygon.color=a.style.line.color,a.style.polygon.fill=!1,a.style.polygon.fillcolor=a.style.line.color,a.style.polygon.fillcolor.alpha=.5);var r=new Cesium.GeoJsonDataSource,i=r.defaultPoint,o=new Cesium.DynamicPoint;o.color=new Cesium.ConstantProperty(C(a.style.point.color)),o.pixelSize=new Cesium.ConstantProperty(a.style.point.size),o.outlineColor=new Cesium.ConstantProperty(Cesium.Color.BLACK),o.outlineWidth=new Cesium.ConstantProperty(1),i.point=o;var s=r.defaultLine,n=new Cesium.DynamicPolyline,l=new Cesium.ColorMaterialProperty;l.color=new Cesium.ConstantProperty(C(a.style.line.color)),n.material=l,n.width=new Cesium.ConstantProperty(a.style.line.width),s.polyline=n;var c=r.defaultPolygon;c.polyline=n;var v=new Cesium.DynamicPolygon;v.fill=new Cesium.ConstantProperty(a.style.polygon.fill),c.polygon=v,l=new Cesium.ColorMaterialProperty,l.color=new Cesium.ConstantProperty(C(a.style.polygon.fillcolor)),v.material=l;var d=p(e);if(""!==d&&"EPSG:4326"!==d)h(d)?console.log("GeoJSONDataSource will convert this"):(console.log("===Going to spatial reference service to try to get proj4 string"),u(d,function(){console.log("ADD LOADING FUNC HERE")}));else{var _=JSON.stringify(e).length,S={tot:0,longest:0};y(e,"coordinates",function(e){T(e,S)}),console.log("finished",S),S.longest>100&&S.tot>1e5&&(m(e),console.log("downsampled object from",_,"bytes to",JSON.stringify(e).length))}if(void 0===a.map)r.load(e),this.dataSourceCollection.add(r),a.dataSource=r,a.extent||(a.extent=f(r));else{var D={color:"#ff7800",weight:5,opacity:.65};L.geoJson(e,{style:D}).addTo(a.map)}return a},t.exports=D},{"./GeoData":2,"./TableDataSource":4}],4:[function(e,t){"use strict";var a=e("./Dataset"),r=(Cesium.defaultValue,function(){this.czmlDataSource=new Cesium.CzmlDataSource,this.dataset=new a,this.show=!0,this.color=Cesium.Color.RED,this.pts_max=1e4,this.leadTimeMin=0,this.trailTimeMin=60,this.scale=1,this.scale_by_val=!0;var e=[{offset:0,color:"#00f"},{offset:.25,color:"#0ff"},{offset:.25,color:"#0ff"},{offset:.5,color:"#0f0"},{offset:.5,color:"#0f0"},{offset:.75,color:"#ff0"},{offset:.75,color:"#ff0"},{offset:1,color:"#f00"}];this.colorGradient=e,this.setColorGradient(e)});Cesium.defineProperties(r.prototype,{name:{get:function(){return this.czmlDataSource.name}},clock:{get:function(){return this.czmlDataSource.clock}},dynamicObjects:{get:function(){return this.czmlDataSource.dynamicObjects}},isLoading:{get:function(){return this.czmlDataSource.isLoading}},changedEvent:{get:function(){return this.czmlDataSource.changedEvent}},errorEvent:{get:function(){return this.czmlDataSource.errorEvent}},loadingEvent:{get:function(){return this.czmlDataSource.loadingEvent}}}),r.prototype.loadUrl=function(e){var t=this;this.dataset.loadUrl({url:e,callback:function(){t.setLeadTimeByPercent(0),t.setTrailTimeByPercent(1),t.czmlDataSource.load(t.getDataPointList(),"TableDataSource")}})},r.prototype.loadText=function(e){var t=this;this.dataset.loadText(e),t.setLeadTimeByPercent(0),t.setTrailTimeByPercent(1),t.czmlDataSource.load(t.getDataPointList(),"TableDataSource")},r.prototype.setCurrentVariable=function(e){var t=this;this.dataset.setCurrentVariable({variable:e,callback:function(){t.czmlDataSource.load(t.getDataPointList(),"TableDataSource")}})},r.prototype.czmlRecFromPoint=function(e){var t={billboard:{horizontalOrigin:"CENTER",verticalOrigin:"BOTTOM",image:"./images/pow32.png",scale:1,color:{rgba:[255,0,0,255]},show:[{interval:"2011-02-04T16:00:00Z/2011-04-04T18:00:00Z","boolean":!0}]},position:{cartographicDegrees:[0,0,0]}};t.billboard.color.rgba=this._mapValue2Color(e.val),t.billboard.scale=this._mapValue2Scale(e.val);for(var a=0;3>a;a++)t.position.cartographicDegrees[a]=e.pos[a];var r=e.time.addMinutes(-this.leadTimeMin),i=e.time.addMinutes(this.trailTimeMin);return t.billboard.show[0].interval=r.toIso8601()+"/"+i.toIso8601(),t},r.prototype.getDataPointList=function(){var e=this.dataset;if(!e._loadingData){for(var t=this.dataset.getPointList(),a=[],r=0;r<t.length;r++){var i=this.czmlRecFromPoint(t[r]);a.push(i)}return a}},r.prototype._getNormalizedPoint=function(e){var t=this.dataset;if(void 0===t||t.isNoData(e))return void 0;var a=t.getMinVal(),r=t.getMaxVal(),i=r===a?0:(e-a)/(r-a);return i},r.prototype._mapValue2Scale=function(e){var t=this.scale,a=this._getNormalizedPoint(e);return void 0!==a&&(t*=this.scale_by_val?1*a+.5:1),t},r.prototype._mapValue2Color=function(e){var t=this.dataImage;if(void 0===t)return this.color;var a=this._getNormalizedPoint(e),r=[0,0,0,0];if(void 0!==a){var i=4*Math.floor(a*(t.data.length/4-1));r=t.data.subarray(i,i+4),r[3]*=this.color.alpha}return r},r.prototype.setLeadTimeByPercent=function(e){if(this.dataset){var t=this.dataset;this.leadTimeMin=t.getMinTime().getMinutesDifference(t.getMaxTime())*e/100}},r.prototype.setTrailTimeByPercent=function(e){if(this.dataset){var t=this.dataset;this.trailTimeMin=t.getMinTime().getMinutesDifference(t.getMaxTime())*e/100}},r.prototype.createGradient=function(e){for(var t=e.canvas.width,a=e.canvas.height,r=e.createLinearGradient(0,0,0,a),i=this.colorGradient,o=0;o<i.length;o++)r.addColorStop(i[o].offset,i[o].color);e.fillStyle=r,e.fillRect(0,0,t,a)},r.prototype.setColorGradient=function(){document.getElementById("grad_div")||($("body").append('<div id="grad_div"></div>'),$("<canvas/>",{id:"gradCanvas",Width:64,Height:256,Style:"display: none"}).appendTo("#grad_div"));var e=$("#gradCanvas")[0],t=e.getContext("2d");this.createGradient(t),this.dataImage=t.getImageData(0,0,1,256)},r.prototype.destroy=function(){return Cesium.destroyObject(this)},t.exports=r},{"./Dataset":1}],5:[function(e,t){"use strict";function a(e){return!isNaN(parseFloat(e))&&isFinite(e)}function r(e){var t=e.split(/[/-]/);return 3===t.length&&(e=t[1]+"/"+t[0]+"/"+t[2]),e}var i={LON:0,LAT:1,ALT:2,TIME:3,SCALAR:4,ENUM:5},o=function(){this.vals=[],this.fNoData=1e-34,this.min=void 0,this.max=void 0,this.type=void 0,this.time_var=void 0,this.enum_list=void 0};o.prototype._calculateVarMinMax=function(){for(var e=this.vals,t=Number.MAX_VALUE,a=-Number.MAX_VALUE,r=0;r<e.length;r++)void 0===e[r]||null===e[r]?e[r]=this.fNoData:(t>e[r]&&(t=e[r]),a<e[r]&&(a=e[r]));this.min=t,this.max=a},o.prototype._calculateTimeMinMax=function(){for(var e=this.vals,t=e[0],a=e[0],r=1;r<e.length;r++)t.greaterThan(e[r])&&(t=e[r]),a.lessThan(e[r])&&(a=e[r]);this.min=t,this.max=a},o.prototype.processTimeVar=function(){function e(e){return Cesium.JulianDate.fromDate(new Date(e))}function t(e){var t=Cesium.JulianDate.fromDate(new Date("January 1, 1970 0:00:00"));return t=t.addDays(Math.floor(e)-25569),t=t.addSeconds(60*(e-Math.floor(e))*60*24)}function s(e){return Cesium.JulianDate.fromDate(Date.setTime(e))}function n(e){var t=new Cesium.JulianDate(0,0),a=e.toString(),r=parseInt(a.substring(0,4),10),i=parseInt(a.substring(4,7),10);if(14!==a.length||1950>r||r>2050||i>366)return t;var o=new Date;return o.setUTCFullYear(r),o.setUTCHours(a.substring(7,9),a.substring(9,11),a.substring(11,13)),t=Cesium.JulianDate.fromDate(o).addDays(i)}if(this.type===i.TIME){var l,u=new o,p=this.vals;l=parseInt(p[0],10)>5e5?0!==n(p[0]).getJulianDayNumber()?n:s:a(p[0])?t:e;var h=!1;try{for(var c=0;c<p.length;c++)u.vals[c]=l(p[c]);h=!0}catch(v){if(l===e){console.log("Trying swap of day and month in date strings"),u.vals=[];try{for(var c=0;c<p.length;c++)u.vals[c]=l(r(p[c]));h=!0}catch(v){}}}h?(u._calculateTimeMinMax(),this.time_var=u):(this.type=i.SCALAR,console.log("Unable to parse time variable"))}},o.prototype.processEnumVar=function(){if(this.type===i.ENUM){for(var e=[],t=0;t<this.vals.length;t++){this.vals[t]===this.fNoData&&(this.vals[t]="undefined");var a=e.indexOf(this.vals[t]);-1===a&&(a=e.length,e.push(this.vals[t])),this.vals[t]=parseFloat(a)}this.enum_list=e,this.calculateVarMinMax()}},o.prototype.guessVarType=function(e){function t(e,t){var e=e.toLowerCase();for(var a in t){var r=t[a].toLowerCase();if(0===e.indexOf(r)||-1!==e.indexOf(" "+r)||-1!==e.indexOf("_"+r))return!0}return!1}var a=[{hints:["lon"],type:i.LON},{hints:["lat"],type:i.LAT},{hints:["depth","height","elevation"],type:i.ALT},{hints:["time","date"],type:i.TIME}];for(var r in a)if(t(e,a[r].hints))return void(this.type=a[r].type);this.type=i.SCALAR},o.prototype.destroy=function(){return Cesium.destroyObject(this)},t.exports=o},{}],6:[function(e,t){t.exports={Variable:e("./Variable"),Dataset:e("./Dataset"),TableDataSource:e("./TableDataSource"),GeoData:e("./GeoData"),GeoDataCollection:e("./GeoDataCollection")}},{"./Dataset":1,"./GeoData":2,"./GeoDataCollection":3,"./TableDataSource":4,"./Variable":5}]},{},[6])(6)});